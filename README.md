# Структура сервиса gophermart 

## База данных

Сервис сохраняет данные в базу данных Postgres, схема данных приведена на рисунке:

![DB Scheme](https://raw.githubusercontent.com/SavchenkoIM/yapracticum-go-diploma-1/devbranch/doc/gophermart-schema.png)

Финансовая информация хранится как `bigint`, на стороне приложения go обрабатывается кастомным типом данных `Numeric`

В таблице `users` предусмотрены столбцы `balance` и `withdrawals`, оба с `CONSTRAINT CHECK >= 0`, в них харнится соответственно общий баланс и сумма списаний с бонусного счёта.

Начисление баллов за заказ происходит в рамках транзакции со степенью изоляции `ReadCommitted`, которая объединяет операции `UPDATE orders (accrual, status)` и `UPDATE users (balance)`. По идее тут ничего не должно пойти не так даже без транзакции, разве что база данных ляжет посреди двух UPDATE.

Списание баллов происходит в рамках транзакции со степенью изоляции `ReadCommitted`, которая объединяет операции `INSERT withdrawals` и `UPDATE users (balance, withdrawals)`. Две транзакции с такой степенью изоляции не станут делать одновременно `UPDATE users`, вторая транзакция подождёт окончания первой. Условие для отката транзации – нарушение `CHECK (balance >= 0)`.

## Аутентификация

Аутентификация реализована через куки, в котором передаётся jwt токен с user_id (соответствует id пользователя из БД), временем выпуска токена и его экспирации.

Проверку аутентификации для нужных путей осуществляет middlware `CustomAuth`. В случае успешной аутентификации добавляется хэдер `LoggedUserID`, информацию из которого используют хэндлеры.

## Тестирование

Тестирование на данный момент реализовано на базе вебинара "продвинутое тестирование", тестируется непосредственно логика работы Storage.

## Опрос системы начисления баллов

Реализован в виде одной рутины, которая раз в 3 секуны проверяет базу на наличие необработанных записей, и если такие есть, последовательно для каждого заказа делает запрос в систему расчёта вознаграждения.

Если система расчёта вознаграждения ответила с кодом `200`, производим операцию "начисление баллов" (транзакция из двух UPDATE), если ответила с кодом `429`, то перед следующим запросом ждём указанное количество секунд.  
При получении любого другого кода просто переходим к следующему запросу.

## TODO

— Прикрутить Prometeus.

— Написать тесты, тестирующие всю логику работы сервера, включая хэндлеры, рутины и т.д.