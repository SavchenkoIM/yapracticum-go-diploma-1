# Структура сервиса gophermart 

![Scheme](https://raw.githubusercontent.com/SavchenkoIM/yapracticum-go-diploma-1/devbranch2/doc/schemeService.png)

## База данных

Сервис сохраняет данные в базу данных Postgres, схема данных приведена на рисунке:

![DB Scheme](https://raw.githubusercontent.com/SavchenkoIM/yapracticum-go-diploma-1/devbranch2/doc/schemeDB.png)

Финансовая информация хранится как `bigint`, на стороне приложения go обрабатывается кастомным типом данных `Numeric`

В таблице `users` предусмотрены столбцы `balance` и `withdrawals`, оба с `CONSTRAINT CHECK >= 0`, в них харнится соответственно общий баланс и сумма списаний с бонусного счёта.

Начисление баллов за заказ происходит в рамках транзакции со степенью изоляции `ReadCommitted`, которая объединяет операции `UPDATE orders (accrual, status)` и `UPDATE users (balance)`. Если первый UPDATE изменяет ноль строк, транзакция откатывается (это означает, что была попытка провести начисление по уже финализированному заказу).

Списание баллов происходит в рамках транзакции со степенью изоляции `ReadCommitted`, которая объединяет операции `INSERT withdrawals` и `UPDATE users (balance, withdrawals)`. Две транзакции с такой степенью изоляции не станут делать одновременно `UPDATE users`, вторая транзакция подождёт окончания первой. Условие для отката транзации – нарушение `CHECK (balance >= 0)`.

## Аутентификация

Аутентификация реализована через куки, в котором передаётся jwt токен с user_id (соответствует id пользователя из БД), временем выпуска токена и его экспирации.

Проверку аутентификации для нужных путей осуществляет middlware `CustomAuth`. В случае успешной аутентификации добавляется хэдер `LoggedUserID`, информацию из которого используют хэндлеры.

## Тестирование

Реализовано как тестирование отдельно логики работы Storage, так и тестирование всего сервиса целиком. Покрытие Storage определяется как 80,4%.

Для тестирования сервиса наспиан тестовый сервер `Accrual` (с БД `Redis`) с едиснтвенным нужным для обмена с gophermart хэндлером, который ведёт себя следующим образом:  
– Если такой заказ не был ранее добавлен, возвращается `REGISTERED`.  
– Заказ обрабатывается 3 секунды. Если заказ ещё не обработан, возвращается `PROCESSING`, если уже обработан, возвращается `PROCESSED` и сумма начисления, равная "номер заказа" копеек.  
– Если передать номер заказа 429, то этот заказ будет принят в обработку, а все последующие запросы в течение 15 секунд будут возвращать статус `Status: 429; Retry-After: 15`. После истечения этих 15 секеунд запросы заказа 429 ещё 45 секунд обрабатываются как и все остальные (то есть можно получить данные о начислении по заказу 429).  
– Тестовый `Accrual` сохраняет информацию о попытках опрашивать его в период, когда он "недоступен". Это требуется для проверки того факта, что `gophermart` правильно реагирует на ответ 429.

Тестирование включает в себя проверку поведения при ответе 429, а также обработку "одновременно" свалившихся на сервис пятиста новых заказов (ёмкость канала хранения заказов для воркеров при этом берётся 300, поэтому тестируется в том числе "аварийная" логика отложенной обработки заказов).

## Опрос системы начисления баллов

Реализован в виде пяти воркеров, которые обрабатывают данные из канала типа `OrderTag {OrderNum string, PollAfter time.Time, IssuedAt time.Time}`.

Данные в канал помещают:  
– `Storage` при вызове соответствующего хэндлера пользователем
– Рутина `GetUnhandledOrders`, которая раз в минуту проверяет базу данных на предмет необработанных заказов. Последняя служит для выгрузки необработанных заказов в канал при старте сервиса, а также в случае, если в результате непредвиденно высокой пиковой нагрузки часть заказов не удалось поместить в канал из-за его переполнения.

Воркеры и `GetUnhandledOrders` находятся в одном пакете, и имеют разделённую переменную `time.Time` в которой записывается время последнего запуска `GetUnhandledOrders`. Все тэги заказов, у которых время `IssuedAt` старше этого значения, отбрасываются воркерами, что гарантирует отсутствие дублирования одного и того же заказа в канале.  

Если полученный воркером тэг содержит время `PollAfter`, которое раньше текущего времени, делается запрос к accrual по этому заказу. В противном случае тэг возвращается в канал.  
Если ответ accrual имеет окончательный статус, информация заносится в базу данных gophermart (транзакция из двух UPDATE).  
Если ответ имеет неокончательный статус или при записи данных в БД произошла ошибка, тэг возвращается в канал, и его `PollAfter` принимается равным `NOW + 5*Second`.    
Таким образом, опрос системы по одному и тому же заказу не может происходить чаще, чем раз в 5 секунд.

Если accrual ответил с кодом 429, то все воркеры перестают слать запросы до даты/времени `NOW + ({Retry-After}+3)*time.Second`.

## TODO

— Прикрутить Prometeus (тестовый проект уже написал).

